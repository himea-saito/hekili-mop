# Rogue: Subtlety (MoP 5.5.1) 
# Based on WoWSims MoP Subtlety Rogue mechanics and T16H patterns
# See MistsOfPandaria/Priorities/RogueSubtlety_wowsims.simc for a direct JSON-to-SimC translation.

## Precombat Actions
# MoP Classic combat-start rules: you cannot carry procs, and CP are wiped unless Premeditation is on cooldown (then you start with 2cp); Premed is reset to 20s on pull. SimC cannot model the wipe/reset directly, but opener remains Premed > SnD for parity.

actions.precombat+=/potion
actions.precombat+=/premeditation,if=talent.premeditation.enabled
actions.precombat+=/stealth,if=!stealthed.all
actions.precombat+=/marked_for_death,if=talent.marked_for_death.enabled
actions.precombat+=/slice_and_dice,if=combo_points>=1&!stealthed.all

## Main Actions
actions+=/kick,if=target.casting
actions+=/potion,if=buff.bloodlust.react|target.time_to_die<40
actions+=/use_item,slot=hands,if=buff.shadow_dance.up|target.time_to_die<20
actions+=/use_item,slot=trinket1,if=buff.shadow_dance.up|buff.shadow_blades.up|target.time_to_die<20
actions+=/use_item,slot=trinket2,if=buff.shadow_dance.up|buff.shadow_blades.up|target.time_to_die<20
actions+=/blood_fury,if=buff.shadow_dance.up
actions+=/berserking,if=buff.shadow_dance.up
actions+=/arcane_torrent,if=energy<60
actions+=/preparation,if=!buff.vanish.up&cooldown.vanish.remains>60&talent.preparation.enabled
# Core rotation
actions+=/run_action_list,name=aoe,if=active_enemies>=3
actions+=/call_action_list,name=cooldowns

# WoWSims-style stealth handling: Subterfuge opener and end-of-dance energy gating.
actions+=/garrote,if=settings.use_garrote&time=0&stealthed.all
actions+=/ambush,if=buff.shadow_dance.up&buff.shadow_dance.remains<=1.5&energy>=40
actions+=/ambush,if=buff.subterfuge.up&energy>=60
actions+=/premeditation,if=talent.premeditation.enabled&(stealthed.all|buff.shadow_dance.up)&combo_points<=4
actions+=/slice_and_dice,if=!stealthed.all&combo_points>=1&(buff.slice_and_dice.down|buff.slice_and_dice.remains<=(6+6*combo_points)*0.5)
actions+=/rupture,if=combo_points>=5&(!dot.rupture.ticking|dot.rupture.remains<=(4+4*combo_points)*0.5)&target.time_to_die>10
actions+=/hemorrhage,if=talent.hemorrhage.enabled&(!dot.hemorrhage.ticking|dot.hemorrhage.remains<4)
actions+=/eviscerate,if=combo_points>=5&dot.rupture.up
actions+=/ambush,if=buff.shadow_dance.up&combo_points<5
actions+=/backstab,if=combo_points<5&energy>=35

# Cooldowns
actions.cooldowns+=/shadow_dance,if=settings.use_shadow_dance&energy>=80&!stealthed.all&buff.slice_and_dice.remains>=6&(dot.rupture.remains>=10|dot.hemorrhage.remains>=10)&debuff.find_weakness.remains<=3&combo_points<=3
actions.cooldowns+=/shadow_dance,if=settings.use_shadow_dance&energy>=settings.energy_threshold&!stealthed.all&buff.slice_and_dice.up&dot.rupture.remains>=settings.dance_min_rupture
actions.cooldowns+=/vanish,if=energy>=80&combo_points<=2&!stealthed.all&cooldown.shadow_dance.remains>=10&(dot.rupture.remains>=10|dot.hemorrhage.remains>=10)&debuff.find_weakness.remains<=3
actions.cooldowns+=/shadowmeld,if=race.night_elf&energy>=60&combo_points<=2&!stealthed.all&cooldown.shadow_dance.remains>=10&cooldown.vanish.remains>=10&(dot.rupture.remains>=10|dot.hemorrhage.remains>=10)&debuff.find_weakness.remains<=3
actions.cooldowns+=/shadow_blades,if=talent.shadow_blades.enabled&settings.use_shadow_blades&!stealthed.all&!buff.shadow_dance.up&debuff.find_weakness.down&energy>=80
actions.cooldowns+=/shadow_blades,if=talent.shadow_blades.enabled&settings.use_shadow_blades&target.time_to_die<40
actions.cooldowns+=/shadowstep,if=settings.allow_shadowstep&talent.shadowstep.enabled&target.distance>=12

# AoE
actions.aoe+=/slice_and_dice,if=combo_points>=1&(buff.slice_and_dice.down|buff.slice_and_dice.remains<=(6+6*combo_points)*0.5)
actions.aoe+=/crimson_tempest,if=combo_points>=4&active_enemies>=4&(dot.crimson_tempest.down|dot.crimson_tempest.remains<=(4+2*combo_points)*0.5)
actions.aoe+=/eviscerate,if=combo_points>=5
actions.aoe+=/ambush,if=buff.shadow_dance.up&combo_points<5
actions.aoe+=/fan_of_knives,if=combo_points<5&active_enemies>=3

# Generators
actions.generators+=/marked_for_death,if=talent.marked_for_death.enabled&combo_points=0
actions.generators+=/hemorrhage,if=talent.hemorrhage.enabled&combo_points<5&(!dot.hemorrhage.ticking|dot.hemorrhage.remains<4)
actions.generators+=/backstab,if=combo_points<5&energy>=35
actions.generators+=/shuriken_toss,if=talent.shuriken_toss.enabled&combo_points<5&energy<40